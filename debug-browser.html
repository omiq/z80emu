<!DOCTYPE html>
<html>
<head>
    <title>Z80 Adapter Browser Debug</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        .debug { margin: 10px 0; padding: 10px; border: 1px solid #0f0; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .info { color: #0ff; }
        button { background: #0f0; color: #000; border: none; padding: 10px; margin: 5px; cursor: pointer; }
        button:hover { background: #0a0; }
        pre { background: #111; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>[DEBUG] Z80 Adapter Browser Debug</h1>
    
    <div class="debug">
        <h3>Test Controls</h3>
        <button onclick="testZ80Adapter()">Test Z80 Adapter</button>
        <button onclick="testDiskLoading()">Test Disk Loading</button>
        <button onclick="createTestDisk()">Create Test Disk</button>
        <button onclick="testFullBoot()">Test Full Boot Process</button>
        <button onclick="testIndexedDB()">Test IndexedDB</button>
        <button onclick="testIdbLibrary()">Test IDB Library</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="debug">
        <h3>Debug Output</h3>
        <div id="output"></div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/idb@8/build/umd.js"></script>
    <script src="memio.js?v=2025.01.28.109"></script>
    <script src="z80-adapter-browser.js?v=2025.01.28.110"></script>
    
    <script>
        let logOutput = '';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logOutput += logEntry + '\n';
            
            const outputDiv = document.getElementById('output');
            const logDiv = document.createElement('div');
            logDiv.className = type;
            logDiv.textContent = logEntry;
            outputDiv.appendChild(logDiv);
            
            console.log(logEntry);
        }
        
        function clearLog() {
            logOutput = '';
            document.getElementById('output').innerHTML = '';
        }
        
        async function testZ80Adapter() {
            log('[TEST] Testing Z80 Adapter...', 'info');
            
            try {
                // Create a simple mock memio
                const mockMemio = {
                    ram: new Array(65536).fill(0),
                    rd: (addr) => mockMemio.ram[addr & 0xFFFF],
                    wr: (addr, val) => { mockMemio.ram[addr & 0xFFFF] = val & 0xFF; return val; },
                    input: (port) => 0xFF,
                    output: (port, val) => {}
                };
                
                // Test basic instructions
                mockMemio.ram[0] = 0x3E; // LD A,n
                mockMemio.ram[1] = 0x42; // n = 0x42
                mockMemio.ram[2] = 0x00; // NOP
                
                const cpu = new Z80Adapter(mockMemio);
                cpu.pc = 0;
                
                log(`CPU created: PC=0x${cpu.pc.toString(16).padStart(4, '0')}`, 'info');
                
                // Execute first instruction
                const result1 = cpu.step();
                log(`Step 1 result: ${result1}, A=0x${cpu.a.toString(16).padStart(2, '0')}, PC=0x${cpu.pc.toString(16).padStart(4, '0')}`, result1 ? 'success' : 'error');
                
                // Execute second instruction
                const result2 = cpu.step();
                log(`Step 2 result: ${result2}, PC=0x${cpu.pc.toString(16).padStart(4, '0')}`, result2 ? 'success' : 'error');
                
                log('[OK] Z80 Adapter test completed', 'success');
                
            } catch (error) {
                log(`[ERROR] Z80 Adapter test failed: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testDiskLoading() {
            log('[DISK] Testing Disk Loading...', 'info');
            
            try {
                // Use IDB library directly instead of creating Memio instance
                const db = await idb.openDB('emu8080', 1, {
                    upgrade: function(db, oldVersion, newVersion) {
                        if (!db.objectStoreNames.contains('sectors')) {
                            db.createObjectStore('sectors', { keyPath: 'id' });
                            log('Sectors store created', 'success');
                        } else {
                            log('Sectors store already exists', 'info');
                        }
                    }
                });
                
                log('Database connection established', 'success');
                
                // Check what's in the database
                log('Checking database contents...', 'info');
                
                try {
                    // List all sectors
                    const sectors = await db.getAll('sectors');
                    log(`Database contains ${sectors.length} sectors`, 'info');
                    
                    if (sectors.length === 0) {
                        log('[WARN] Database is empty - no sectors found', 'error');
                        log('This explains why sector read times out', 'info');
                        log('Need to load a disk image first', 'info');
                        return;
                    }
                    
                    // Show first few sectors
                    for (let i = 0; i < Math.min(sectors.length, 3); i++) {
                        const sector = sectors[i];
                        log(`Sector ${i}: Drive=${sector.drive}, Track=${sector.track}, Sector=${sector.sector}`, 'info');
                    }
                    
                    // Test reading a specific sector
                    log('Testing sector read...', 'info');
                    const testSector = await db.get('sectors', 0*65536+0*256+1-1);
                    if (testSector) {
                        log('Boot sector found in database', 'success');
                        log(`Boot sector data length: ${testSector.data.length}`, 'info');
                        
                        // Show first few bytes
                        let dataDump = 'Boot sector data: ';
                        for (let i = 0; i < Math.min(16, testSector.data.length); i++) {
                            dataDump += `0x${testSector.data[i].toString(16).padStart(2, '0')} `;
                        }
                        log(dataDump, 'info');
                    } else {
                        log('Boot sector not found', 'error');
                    }
                    
                } catch (dbError) {
                    log(`Database query error: ${dbError.message}`, 'error');
                }
                
            } catch (error) {
                log(`[ERROR] Disk loading test failed: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function createTestDisk() {
            log('[DISK] Creating test disk image...', 'info');
            
            try {
                log('IDB library found, attempting to open database...', 'info');
                
                // Test the idb library first with a simple operation
                log('Testing idb library with simple database...', 'info');
                try {
                    const testDb = await idb.openDB('test-simple', 1, {
                        upgrade: function(db) {
                            if (!db.objectStoreNames.contains('test')) {
                                db.createObjectStore('test', { keyPath: 'id' });
                                log('Test store created successfully', 'success');
                            }
                        }
                    });
                    log('Simple test database opened successfully', 'success');
                    
                    // Test a simple put/get operation
                    await testDb.put('test', { id: 1, value: 'test' });
                    const testResult = await testDb.get('test', 1);
                    log(`Test operation successful: ${JSON.stringify(testResult)}`, 'success');
                    
                    // Close test database
                    testDb.close();
                    log('Test database closed', 'info');
                    
                } catch (testError) {
                    log(`[ERROR] IDB library test failed: ${testError.message}`, 'error');
                    console.error('IDB test error:', testError);
                    return;
                }
                
                // Use the existing IDB library directly instead of creating new Memio
                // Use the same database name that Memio expects
                const db = await idb.openDB('emu8080', 1, {
                    upgrade: function(db, oldVersion, newVersion) {
                        if (!db.objectStoreNames.contains('sectors')) {
                            db.createObjectStore('sectors', { keyPath: 'id' });
                            log('Sectors store created', 'success');
                        } else {
                            log('Sectors store already exists', 'info');
                        }
                    }
                });
                
                log('Database connection established', 'success');
                        
                        // Create a simple CP/M boot sector
                        const bootSector = [
                            0xC3, 0x00, 0x01,  // JP 0x0100 (jump to CP/M entry point)
                            0x00, 0x00, 0x00,  // NOPs
                            0x00, 0x00, 0x00,  // NOPs
                            0x00, 0x00, 0x00,  // NOPs
                            0x00, 0x00, 0x00,  // NOPs
                            0x00, 0x00, 0x00   // NOPs
                        ];
                        
                        // Fill the rest with zeros
                        const sectorData = new Array(128).fill(0);
                        for (let i = 0; i < bootSector.length; i++) {
                            sectorData[i] = bootSector[i];
                        }
                        
                        // Write the boot sector to the database
                        log('Writing boot sector to database...', 'info');
                        log('Sector data length: ' + sectorData.length, 'info');
                        
                        const sectorRecord = {
                            id: 0*65536+0*256+1-1, // Drive 0, Track 0, Sector 1
                            drive: 0,
                            track: 0,
                            sector: 1,
                            dirty: 0,
                            data: sectorData
                        };
                        
                        log('Sector record prepared, calling db.put...', 'info');
                        
                        const result = await db.put('sectors', sectorRecord);
                        log('Database write completed, result: ' + result, 'info');
                        
                        log('[OK] Test disk created successfully!', 'success');
                        log('Boot sector contains: ' + bootSector.map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '), 'info');
                
            } catch (error) {
                log(`[ERROR] Test disk creation failed: ${error.message}`, 'error');
                console.error('General error:', error);
            }
        }
        
        async function testFullBoot() {
            log('[BOOT] Testing Full Boot Process...', 'info');
            
            try {
                // Use IDB library directly instead of creating Memio instance
                const db = await idb.openDB('emu8080', 1, {
                    upgrade: function(db, oldVersion, newVersion) {
                        if (!db.objectStoreNames.contains('sectors')) {
                            db.createObjectStore('sectors', { keyPath: 'id' });
                            log('Sectors store created', 'success');
                        } else {
                            log('Sectors store already exists', 'info');
                        }
                    }
                });
                
                log('Database ready, checking boot sector...', 'info');
                
                // Check if boot sector exists
                const sector = await db.get('sectors', 0*65536+0*256+1-1);
                if (sector) {
                    log('Boot sector found in database', 'success');
                    
                    // Simulate loading boot sector into memory
                    log('Simulating boot sector load to address 0x0000...', 'info');
                    
                    // Create a mock memory array
                    const mockRam = new Array(65536).fill(0);
                    for (let i = 0; i < sector.data.length; i++) {
                        mockRam[i] = sector.data[i];
                    }
                    
                    // Show memory contents
                    let memDump = 'Boot sector at 0x0000: ';
                    for (let i = 0; i < 16; i++) {
                        memDump += `0x${mockRam[i].toString(16).padStart(2, '0')} `;
                    }
                    log(memDump, 'info');
                    
                    // Test CPU execution with mock memory
                    log('Testing CPU execution...', 'info');
                    const mockMemio = {
                        ram: mockRam,
                        rd: (addr) => mockRam[addr & 0xFFFF],
                        wr: (addr, val) => { mockRam[addr & 0xFFFF] = val & 0xFF; return val; },
                        input: (port) => 0xFF,
                        output: (port, val) => {}
                    };
                    
                    const cpu = new Z80Adapter(mockMemio);
                    cpu.pc = 0;
                    
                    log(`CPU initialized: PC=0x${cpu.pc.toString(16).padStart(4, '0')}`, 'info');
                    
                    // Execute a few instructions
                    for (let i = 0; i < 5; i++) {
                        const result = cpu.step();
                        log(`Step ${i+1}: result=${result}, PC=0x${cpu.pc.toString(16).padStart(4, '0')}, A=0x${cpu.a.toString(16).padStart(2, '0')}`, result ? 'success' : 'error');
                        
                        if (!result) {
                            log('CPU step failed - stopping execution', 'error');
                            break;
                        }
                        
                        if (cpu.pc >= 0x0100) {
                            log('CPU jumped to CP/M entry point - success!', 'success');
                            break;
                        }
                    }
                    
                } else {
                    log('Boot sector not found in database', 'error');
                    log('Run "Create Test Disk" first to create a boot sector', 'info');
                }
                
            } catch (error) {
                log(`[ERROR] Full boot test failed: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testIndexedDB() {
            log('[TEST] Testing IndexedDB...', 'info');
            try {
                const db = await new Promise(resolve => {
                    const request = indexedDB.open('test-db', 1);
                    request.onerror = (event) => {
                        log(`IndexedDB error: ${request.error.message}`, 'error');
                        resolve(null);
                    };
                    request.onsuccess = (event) => {
                        log('IndexedDB connection successful', 'success');
                        resolve(event.target.result);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('test-store')) {
                            db.createObjectStore('test-store', { keyPath: 'id' });
                            log('IndexedDB store created', 'success');
                        } else {
                            log('IndexedDB store already exists', 'info');
                        }
                    };
                });

                if (db) {
                    log('IndexedDB ready for use', 'success');
                    const store = db.transaction('test-store', 'readwrite').objectStore('test-store');

                    const testData = { id: 1, name: 'Test Item' };
                    log('Attempting to add test data...', 'info');
                    await store.add(testData);
                    log('Test data added', 'success');

                    log('Attempting to get test data...', 'info');
                    const result = await store.get(1);
                    log(`Test data retrieved: ${JSON.stringify(result)}`, 'info');

                    log('Attempting to delete test data...', 'info');
                    await store.delete(1);
                    log('Test data deleted', 'success');

                    log('[OK] IndexedDB test completed', 'success');
                } else {
                    log('IndexedDB not available', 'error');
                }
            } catch (error) {
                log(`[ERROR] IndexedDB test failed: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function testIdbLibrary() {
            log('[TEST] Testing IDB Library...', 'info');
            try {
                if (typeof idb === 'undefined') {
                    log('[ERROR] IDB library not loaded', 'error');
                    return;
                }
                
                log('IDB library available, testing connection...', 'info');
                const db = await idb.openDB('test-idb-db', 1, {
                    upgrade: function(db, oldVersion, newVersion) {
                        if (!db.objectStoreNames.contains('test-store')) {
                            db.createObjectStore('test-store', { keyPath: 'id' });
                            log('IDB Library store created', 'success');
                        } else {
                            log('IDB Library store already exists', 'info');
                        }
                    }
                });
                
                log('IDB Library connection successful', 'success');

                                log('IDB Library ready for use', 'success');
                
                // Test basic operations
                const testData = { id: 1, name: 'Test Item' };
                log('Attempting to add test data...', 'info');
                await db.put('test-store', testData);
                log('Test data added', 'success');
                
                log('Attempting to get test data...', 'info');
                const result = await db.get('test-store', 1);
                log(`Test data retrieved: ${JSON.stringify(result)}`, 'info');
                
                log('Attempting to delete test data...', 'info');
                await db.delete('test-store', 1);
                log('Test data deleted', 'success');
                
                log('[OK] IDB Library test completed', 'success');
            } catch (error) {
                log(`[ERROR] IDB Library test failed: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // Auto-run basic test on page load
        window.addEventListener('load', () => {
            log('[READY] Debug page loaded, ready for testing', 'success');
        });
    </script>
</body>
</html>
